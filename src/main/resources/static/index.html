<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>GuessTheSong</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            background: rgb(47, 52, 56);
            margin: 0;
        }

        .page {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            padding: 16px;
        }

        .title {
            color: rgb(255, 255, 255);
            text-align: center;
            margin: 8px 0;
        }

        .full-width {
            width: 95vw;
            max-width: 720px;
        }

        .answer-button {
            height: 50vh;
            min-height: 220px;
            font-size: clamp(24px, 6vw, 40px);
            transition: filter 140ms ease;
        }

        .answer-button.flash {
            filter: brightness(1.35);
        }

        .user-badge {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 10;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
        }

        .user-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
        }

        .ws-warning {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 10;
            margin: 0;
        }

        .song-layer {
            position: fixed;
            inset: 0;
            z-index: 20;
            background: rgb(47, 52, 56);
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .song-layer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
        }

        .song-layer-brand {
            margin: 0;
            text-align: left;
        }

        .song-layer-body {
            flex: 1;
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            padding: 12px 0;
        }

        .song-album {
            width: min(78vw, 320px);
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }

        .song-title {
            color: rgb(255, 255, 255);
            text-align: center;
            font-size: clamp(26px, 7vw, 44px);
            font-weight: 700;
            margin: 0;
        }

        .song-artists {
            color: rgba(255, 255, 255, 0.75);
            text-align: center;
            font-size: clamp(16px, 4.8vw, 24px);
            font-weight: 600;
            margin: 0;
        }

        .song-layer-footer {
            max-width: 720px;
            margin: 0 auto;
            padding-bottom: 8px;
        }

        .spotify-login-container {
            margin-top: auto;
            padding-top: 8px;
        }

        .genre-subtitle {
            color: rgba(255, 255, 255, 0.75);
            text-align: center;
            margin: -6px 0 8px 0;
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="wsWarning" class="alert alert-danger py-2 px-3 ws-warning" role="alert" hidden>
        Achtung: Keine Verbindung
    </div>

    <section id="songLayer" class="song-layer" hidden aria-hidden="true">
        <div class="song-layer-header">
            <div class="title song-layer-brand">GuessTheSong</div>
            <button id="closeSongLayer" type="button" class="btn btn-outline-light btn-sm">Zurück</button>
        </div>

        <div class="song-layer-body">
            <img id="songAlbumImage" class="song-album rounded" alt="Albumcover" hidden>
            <h2 id="songTitle" class="song-title">Lade Song...</h2>
            <p id="songArtists" class="song-artists">Lade Künstler...</p>
        </div>

        <div class="full-width song-layer-footer">
            <button id="songLayerContinue" class="btn btn-primary w-100" type="button">Nächste Runde</button>
        </div>
    </section>

    <button id="userButton" type="button" class="btn btn-outline-light user-badge" aria-label="Spielername ändern">
        <svg class="user-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
            <path d="M14 14s-1-4-6-4-6 4-6 4 1 0 6 0 6 0 6 0z" />
        </svg>
        <span id="userNameLabel">...</span>
    </button>

    <main class="page">
        <h1 class="title">GuessTheSong</h1>
        <div id="genreSubtitle" class="genre-subtitle">Genre: —</div>

        <button id="answerButton" class="btn btn-primary full-width answer-button" type="button">Antwort sagen</button>
        <button id="showAnswerButton" class="btn btn-primary full-width" type="button" hidden>Lösung anzeigen</button>
        <button id="guessAgainButton" class="btn btn-primary full-width" type="button" hidden>Weiter raten</button>

        <div id="spotifyLoginContainer" class="full-width spotify-login-container" hidden>
            <a id="spotifyLoginButton" class="btn btn-outline-light w-100" href="/spotify/login">Mit Spotify
                anmelden</a>
            <select id="genreSelect" class="form-select mt-2" aria-label="Genre auswählen">
                <option value="" selected disabled>Genres laden...</option>
            </select>

            <div id="playlistEditor" class="mt-2" hidden>
                <label for="playlistUriInput" class="form-label text-light mb-1">Playlist (URI oder Link)</label>
                <input id="playlistUriInput" class="form-control" type="text"
                    placeholder="spotify:playlist:... oder https://open.spotify.com/playlist/..." autocomplete="off">
            </div>
            <button id="newGameButton" class="btn btn-outline-light w-100 mt-2" type="button">Neues Spiel starten</button>
        </div>
    </main>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script>
        (function () {

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) {
                    return decodeURIComponent(parts.pop().split(';').shift());
                }
                return null;
            }

            function setCookie(name, value) {
                // 365 days
                const maxAge = 60 * 60 * 24 * 365;
                document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
            }

            function getNameFromQueryString() {
                const params = new URLSearchParams(window.location.search);
                // support both ?playerName= and ?name=
                const fromQuery = (params.get('playerName') || params.get('name') || '').trim();
                return fromQuery.length > 0 ? fromQuery : null;
            }

            function promptRequired(message) {
                while (true) {
                    let value = prompt(message);

                    if (value === null) {
                        // "Abbrechen" -> direkt wieder anzeigen
                        continue;
                    }

                    value = value.trim();
                    if (value.length === 0) {
                        // leer -> direkt wieder anzeigen
                        continue;
                    }

                    return value;
                }
            }

            const userButton = document.getElementById('userButton');
            const userNameLabel = document.getElementById('userNameLabel');
            const spotifyLoginContainer = document.getElementById('spotifyLoginContainer');
            const spotifyLoginButton = document.getElementById('spotifyLoginButton');
            const genreSelect = document.getElementById('genreSelect');
            const genreSubtitle = document.getElementById('genreSubtitle');
            const playlistEditor = document.getElementById('playlistEditor');
            const playlistUriInput = document.getElementById('playlistUriInput');
            const newGameButton = document.getElementById('newGameButton');

            let playerName = null;
            let pendingNameMessage = null;
            let pendingGenreChangePayload = null;
            let pendingNewGamePayload = null;
            let genresLoaded = false;

            let currentGenre = null;
            let spotifyConnected = null;

            const GENRES = [
                { value: 'rock', label: 'Rock' },
                { value: 'pop', label: 'Pop' },
                { value: 'electronic', label: 'Electronic' }
            ];

            const DEFAULT_PLAYLIST_URIS_BY_GENRE = {
                rock: 'spotify:playlist:37i9dQZF1DX4vth7idTQch',
                pop: 'spotify:playlist:2OFfgjs6kj0eA6FNayhAAJ',
                electronic: 'spotify:playlist:3tRhisNDv5YZXPQltBbJNc'
            };

            const LEGACY_DEFAULT_PLAYLIST_URIS_BY_GENRE = {
                rock: 'spotify:playlist:6pNlO5t2Rg7XrldHrsYbA7',
                pop: '',
                electronic: ''
            };

            const PLAYLIST_URIS_STORAGE_KEY = 'playlistUrisByGenre';

            function extractSpotifyPlaylistId(text) {
                const raw = (text || '').toString().trim();
                if (!raw) {
                    return null;
                }

                // spotify:playlist:<id>
                const uriMatch = raw.match(/^spotify:playlist:([A-Za-z0-9]{22})$/);
                if (uriMatch) {
                    return uriMatch[1];
                }

                // 22-char id
                const idMatch = raw.match(/^([A-Za-z0-9]{22})$/);
                if (idMatch) {
                    return idMatch[1];
                }

                // open.spotify.com/playlist/<id> (+ params)
                const urlLikeMatch = raw.match(/open\.spotify\.com\/playlist\/([A-Za-z0-9]{22})/);
                if (urlLikeMatch) {
                    return urlLikeMatch[1];
                }

                try {
                    const u = new URL(raw);
                    const pathname = (u.pathname || '').toString();
                    const m = pathname.match(/\/playlist\/([A-Za-z0-9]{22})/);
                    if (m) {
                        return m[1];
                    }
                } catch (e) {
                    // ignore
                }

                return null;
            }

            function normalizePlaylistContextUri(input) {
                const trimmed = (input || '').toString().trim();
                if (!trimmed) {
                    return '';
                }
                const id = extractSpotifyPlaylistId(trimmed);
                if (!id) {
                    return null;
                }
                return `spotify:playlist:${id}`;
            }

            function loadPlaylistUrisByGenre() {
                let stored = {};
                let hasStoredValue = false;
                try {
                    const raw = localStorage.getItem(PLAYLIST_URIS_STORAGE_KEY);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed === 'object') {
                            stored = parsed;
                            hasStoredValue = true;
                        }
                    }
                } catch (e) {
                    // ignore
                }

                // Defaults first, then overlay stored values.
                const merged = {
                    ...DEFAULT_PLAYLIST_URIS_BY_GENRE,
                    ...stored
                };

                // Migration: if localStorage still contains the old defaults, replace them with new defaults.
                if (hasStoredValue) {
                    for (const k of Object.keys(DEFAULT_PLAYLIST_URIS_BY_GENRE)) {
                        const key = k;
                        const current = (merged[key] || '').toString().trim();
                        const legacy = (LEGACY_DEFAULT_PLAYLIST_URIS_BY_GENRE[key] || '').toString().trim();
                        if (current === legacy) {
                            merged[key] = DEFAULT_PLAYLIST_URIS_BY_GENRE[key];
                        }
                    }
                }

                return merged;
            }

            function savePlaylistUrisByGenre(map) {
                try {
                    localStorage.setItem(PLAYLIST_URIS_STORAGE_KEY, JSON.stringify(map || {}));
                } catch (e) {
                    // ignore
                }
            }

            function getPlaylistUriForGenre(genreValue) {
                const key = normalizeGenreValue(genreValue);
                if (!key) {
                    return '';
                }
                const map = loadPlaylistUrisByGenre();
                const value = (map && map[key] != null) ? map[key] : '';
                return (value || '').toString().trim();
            }

            function setPlaylistEditorVisible(visible) {
                if (!playlistEditor) {
                    return;
                }
                playlistEditor.hidden = !visible;
            }

            function syncPlaylistInputForCurrentGenre() {
                if (playerName !== 'Phil') {
                    setPlaylistEditorVisible(false);
                    return;
                }
                if (!genresLoaded || !currentGenre) {
                    setPlaylistEditorVisible(false);
                    return;
                }

                setPlaylistEditorVisible(true);
                if (playlistUriInput) {
                    playlistUriInput.value = getPlaylistUriForGenre(currentGenre);
                }
            }

            function normalizeGenreValue(value) {
                const v = (value || '').toString().trim().toLowerCase();
                if (!v) {
                    return null;
                }
                if (v.includes('rock')) return 'rock';
                if (v.includes('pop')) return 'pop';
                if (v.includes('electronic')) return 'electronic';
                return v;
            }

            function genreLabelForValue(value) {
                const normalized = normalizeGenreValue(value);
                const match = GENRES.find(g => g.value === normalized);
                return match ? match.label : (value || '—');
            }

            function updateSpotifyLoginVisibility() {
                // Only show for the admin/test user
                spotifyLoginContainer.hidden = (playerName !== 'Phil');

                if (playerName === 'Phil') {
                    ensureGenresLoaded();
                } else {
                    // keep dropdown quiet for non-Phil users
                    resetGenreSelect();
                    setPlaylistEditorVisible(false);
                }
            }

            function setCurrentGenre(newGenre) {
                const normalized = normalizeGenreValue(newGenre);
                currentGenre = normalized ? normalized : null;
                genreSubtitle.textContent = `Genre: ${currentGenre ? genreLabelForValue(currentGenre) : '—'}`;

                if (playerName === 'Phil') {
                    ensureGenresLoaded();
                    applyCurrentGenreToDropdown();
                }

                syncPlaylistInputForCurrentGenre();
            }

            function setSpotifyConnected(newValue) {
                // Only relevant for Phil; container is hidden otherwise
                if (playerName !== 'Phil') {
                    spotifyConnected = null;
                    return;
                }

                spotifyConnected = (newValue === true);

                if (spotifyConnected) {
                    spotifyLoginButton.textContent = 'Spotify Verbunden';
                    spotifyLoginButton.classList.remove('btn-outline-light', 'btn-danger');
                    spotifyLoginButton.classList.add('btn-success');
                } else {
                    spotifyLoginButton.textContent = 'Mit Spotify anmelden';
                    spotifyLoginButton.classList.remove('btn-outline-light', 'btn-success');
                    spotifyLoginButton.classList.add('btn-danger');
                }
            }

            function applyCurrentGenreToDropdown() {
                if (playerName !== 'Phil') {
                    return;
                }
                if (!genresLoaded) {
                    return;
                }
                if (!currentGenre) {
                    return;
                }

                // only set if the option exists
                const match = Array.from(genreSelect.options).some(o => o && o.value === currentGenre);
                if (match) {
                    genreSelect.value = currentGenre;
                }
            }

            function resetGenreSelect() {
                genresLoaded = false;
                genreSelect.replaceChildren();
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.disabled = true;
                loadingOption.selected = true;
                loadingOption.textContent = 'Genres laden...';
                genreSelect.appendChild(loadingOption);
            }

            async function ensureGenresLoaded() {
                if (genresLoaded) {
                    return;
                }

                resetGenreSelect();

                // Genres are now hardcoded (playlist-based mode).
                genreSelect.replaceChildren();

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.selected = true;
                placeholder.disabled = true;
                placeholder.textContent = 'Genre auswählen...';
                genreSelect.appendChild(placeholder);

                for (const g of GENRES) {
                    const option = document.createElement('option');
                    option.value = g.value;
                    option.textContent = g.label;
                    genreSelect.appendChild(option);
                }

                genresLoaded = true;
                applyCurrentGenreToDropdown();
                syncPlaylistInputForCurrentGenre();
            }

            if (playlistUriInput) {
                playlistUriInput.addEventListener('change', () => {
                    if (playerName !== 'Phil') {
                        return;
                    }
                    if (!currentGenre) {
                        return;
                    }

                    const raw = (playlistUriInput.value || '').toString();
                    const normalized = normalizePlaylistContextUri(raw);

                    if (normalized === null) {
                        window.alert('Ungültige Playlist URL/URI. Bitte einen Spotify Playlist-Link oder eine spotify:playlist:... URI einfügen.');
                        playlistUriInput.value = getPlaylistUriForGenre(currentGenre);
                        return;
                    }

                    const map = loadPlaylistUrisByGenre();
                    map[currentGenre] = normalized;
                    savePlaylistUrisByGenre(map);
                    playlistUriInput.value = normalized;
                });
            }

            function setPlayerName(newName) {
                playerName = newName;
                userNameLabel.textContent = newName;
                setCookie('playerName', newName);

                updateSpotifyLoginVisibility();

                // reset spotify button state when switching users
                if (playerName === 'Phil') {
                    // keep whatever we already know; UI will update once state arrives
                } else {
                    spotifyLoginButton.textContent = 'Mit Spotify anmelden';
                    spotifyLoginButton.classList.remove('btn-danger', 'btn-success');
                    spotifyLoginButton.classList.add('btn-outline-light');
                }

                // tell server (or queue until WS is open)
                pendingNameMessage = 'name:' + newName;
            }

            function askForPlayerName() {
                const name = promptRequired('Wie heißt du?');
                setPlayerName(name);
            }

            userButton.addEventListener('click', () => {
                askForPlayerName();
            });

            // Initialize name (query string overrides cookie)
            const queryName = getNameFromQueryString();
            const cookieName = (getCookie('playerName') || '').trim();
            if (queryName) {
                setPlayerName(queryName);
            } else if (cookieName.length > 0) {
                setPlayerName(cookieName);
            } else {
                askForPlayerName();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws`;

            const wsWarning = document.getElementById('wsWarning');
            function setWsWarningVisible(visible) {
                wsWarning.hidden = !visible;
            }

            let socket = null;
            let reconnectTimer = null;

            const songLayer = document.getElementById('songLayer');
            const closeSongLayerButton = document.getElementById('closeSongLayer');
            const songLayerContinueButton = document.getElementById('songLayerContinue');
            const guessAgainButton = document.getElementById('guessAgainButton');
            const songAlbumImage = document.getElementById('songAlbumImage');
            const songTitle = document.getElementById('songTitle');
            const songArtists = document.getElementById('songArtists');

            function showSongLayer() {
                songLayer.hidden = false;
                songLayer.setAttribute('aria-hidden', 'false');
            }

            function hideSongLayer() {
                songLayer.hidden = true;
                songLayer.setAttribute('aria-hidden', 'true');
            }

            function setSongInfo(info) {
                const title = (info && (info.songTitle || info.title || info.name) || '—').toString();
                const rawArtists = (info && (info.artistsText ?? info.artists ?? info.artist ?? info.interpret) || '');
                const artistsText = Array.isArray(rawArtists) ? rawArtists.filter(Boolean).join(', ') : rawArtists.toString();
                const imageUrl = (info && (info.albumImageUrl || info.albumImage || info.imageUrl || info.coverUrl) || '').toString();

                songTitle.textContent = title;
                songArtists.textContent = artistsText || '—';

                if (imageUrl) {
                    songAlbumImage.src = imageUrl;
                    songAlbumImage.hidden = false;
                } else {
                    songAlbumImage.hidden = true;
                    songAlbumImage.removeAttribute('src');
                }
            }

            closeSongLayerButton.addEventListener('click', hideSongLayer);

            function sendNextRound() {
                const messageObject = {
                    type: 'nextRound',
                    playerName: playerName
                };
                sendIfOpen(JSON.stringify(messageObject));
            }

            function sendGuessAgain() {
                const messageObject = {
                    type: 'guessAgain',
                    playerName: playerName
                };
                sendIfOpen(JSON.stringify(messageObject));
            }

            songLayerContinueButton.addEventListener('click', () => {
                hideSongLayer();
                sendNextRound();
            });

            guessAgainButton.addEventListener('click', sendGuessAgain);

            function stopReconnectLoop() {
                if (reconnectTimer) {
                    window.clearInterval(reconnectTimer);
                    reconnectTimer = null;
                }
            }

            function startReconnectLoop() {
                // Requirement: try every 10 seconds after disconnect
                if (reconnectTimer) {
                    return;
                }
                reconnectTimer = window.setInterval(() => {
                    if (!socket || socket.readyState === WebSocket.CLOSED) {
                        connectWebSocket();
                    }
                }, 10_000);
            }

            function connectWebSocket() {
                if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                    return;
                }

                setWsWarningVisible(true);

                socket = new WebSocket(wsUrl);

                socket.addEventListener('open', () => {
                    console.log('WebSocket open:', wsUrl);
                    setWsWarningVisible(false);
                    stopReconnectLoop();

                    if (pendingNameMessage) {
                        socket.send(pendingNameMessage);
                        pendingNameMessage = null;
                    }

                    if (pendingGenreChangePayload) {
                        socket.send(pendingGenreChangePayload);
                        pendingGenreChangePayload = null;
                    }

                    if (pendingNewGamePayload) {
                        socket.send(pendingNewGamePayload);
                        pendingNewGamePayload = null;
                    }
                });

                socket.addEventListener('message', (event) => {
                    console.log('WebSocket message:', event.data);
                    try {
                        const messageObject = JSON.parse(event.data);

                        // Update current genre if present
                        if (messageObject && typeof messageObject === 'object') {
                            const maybeGenre = (messageObject.genreName || messageObject.genre || '').toString().trim();
                            if (maybeGenre) {
                                setCurrentGenre(maybeGenre);
                            }

                            if (Object.prototype.hasOwnProperty.call(messageObject, 'spotifyConnected')) {
                                setSpotifyConnected(messageObject.spotifyConnected === true);
                            }
                        }

                        if (messageObject.type === 'firstGuesser') {
                            const answerButton = document.getElementById('answerButton');
                            answerButton.disabled = true;
                            answerButton.textContent = `${messageObject.playerName} war der Erste!`;

                            const showAnswerButton = document.getElementById('showAnswerButton');
                            showAnswerButton.hidden = false;
                        } else if (messageObject.type === 'answer') {
                            setSongInfo(messageObject);
                            showSongLayer();
                        } else if (messageObject.type === 'guessAgain') {
                            const answerButton = document.getElementById('answerButton');
                            answerButton.disabled = false;
                            answerButton.textContent = 'Antwort sagen';

                            const showAnswerButton = document.getElementById('showAnswerButton');
                            showAnswerButton.hidden = true;

                            guessAgainButton.hidden = true;

                            hideSongLayer();
                        } else if (messageObject.type === 'nextRound' || messageObject.type === 'guessAgain') {
                            const answerButton = document.getElementById('answerButton');
                            answerButton.disabled = false;
                            answerButton.textContent = 'Antwort sagen';

                            const showAnswerButton = document.getElementById('showAnswerButton');
                            showAnswerButton.hidden = true;

                            guessAgainButton.hidden = true;

                            setSongInfo(null);
                            hideSongLayer();
                        } else if (messageObject.type === 'genreChange') {
                            setCurrentGenre(messageObject.genreName);
                        }
                    } catch (err) {
                        // ignore non-JSON messages
                    }
                });

                socket.addEventListener('close', (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    setWsWarningVisible(true);
                    startReconnectLoop();
                });

                socket.addEventListener('error', (err) => {
                    console.log('WebSocket error:', err);
                    setWsWarningVisible(true);
                    startReconnectLoop();
                });
            }

            function sendIfOpen(payload) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(payload);
                    return true;
                }
                setWsWarningVisible(true);
                console.log('WebSocket not open');
                return false;
            }

            genreSelect.addEventListener('change', () => {
                const selected = (genreSelect && genreSelect.value || '').toString();
                if (!selected) {
                    return;
                }

                setCurrentGenre(selected);

                const playlistContextUri = getPlaylistUriForGenre(selected);

                const payload = JSON.stringify({
                    type: 'genreChange',
                    genreName: selected,
                    playlistContextUri: playlistContextUri
                });

                const sent = sendIfOpen(payload);
                if (!sent) {
                    pendingGenreChangePayload = payload;
                }
            });

            newGameButton.addEventListener('click', () => {
                if (playerName !== 'Phil') {
                    return;
                }

                const selectedGenre = (genreSelect && genreSelect.value || '').toString().trim();
                if (!selectedGenre) {
                    window.alert('Bitte zuerst ein Genre auswählen.');
                    try { genreSelect.focus(); } catch (e) { /* ignore */ }
                    return;
                }

                const confirmed = window.confirm('Neues Spiel wirklich starten?');
                if (!confirmed) {
                    return;
                }

                const genreName = selectedGenre;
                const playlistContextUri = getPlaylistUriForGenre(genreName);

                const payload = JSON.stringify({
                    type: 'newGame',
                    playerName: playerName
                    ,
                    genreName: genreName,
                    playlistContextUri: playlistContextUri
                });

                const sent = sendIfOpen(payload);
                if (!sent) {
                    pendingNewGamePayload = payload;
                }
            });

            // initial connect
            connectWebSocket();
            startReconnectLoop();

            // BFCache handling: when coming back, re-establish if needed
            window.addEventListener('pageshow', () => {
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    setWsWarningVisible(true);
                    connectWebSocket();
                    startReconnectLoop();
                }
            });

            // If the page is put into BFCache, close the socket so pageshow can reconnect cleanly
            window.addEventListener('pagehide', () => {
                try {
                    if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                        socket.close();
                    }
                } catch (e) {
                    // ignore
                }
            });

            const showAnswerButton = document.getElementById('showAnswerButton');
            showAnswerButton.addEventListener('click', () => {
                const messageObject = {
                    type: 'showAnswer',
                    playerName: playerName
                };
                sendIfOpen(JSON.stringify(messageObject));
            });

            const answerButton = document.getElementById('answerButton');
            answerButton.addEventListener('click', () => {

                answerButton.classList.add('flash');
                window.setTimeout(() => answerButton.classList.remove('flash'), 160);

                // Only show "Weiter raten" after the user has attempted a guess
                guessAgainButton.hidden = false;

                const messageObject = {
                    type: 'playerGuess',
                    playerName: playerName
                };
                sendIfOpen('answer:' + JSON.stringify(messageObject));
            });
        })();
    </script>
</body>

</html>